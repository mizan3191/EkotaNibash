@page "/Expenses"

@rendermode @(new InteractiveServerRenderMode(prerender: false))

@inject ILookup m_Lookup
@inject DialogService DialogService
<Message @ref="notificationComponent" />

<div class="container-fluid">
    <!-- Header Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="dashboard-header">
                <div class="row align-items-center">
                    <div class="col-lg-8">
                        <div class="d-flex align-items-center">
                            <div class="header-icon me-4">
                                <div class="icon-circle bg-gradient-warning">
                                    <i class="fas fa-money-bill-wave text-white"></i>
                                </div>
                            </div>
                            <div class="header-content">
                                <h1 class="display-6 fw-bold mb-2">Monthly Expenses</h1>
                                @if (Expenses != null && Expenses.Any())
                                {
                                    <div class="header-meta d-flex align-items-center gap-3">
                                        <div class="meta-item">
                                            <i class="fas fa-list-ol text-primary me-2"></i>
                                            <span>Total Records: <strong>@Expenses.Count()</strong></span>
                                        </div>
                                        <div class="meta-item">
                                            <i class="fas fa-calculator text-success me-2"></i>
                                            <span>Total Amount: <strong>৳@Expenses.Sum(o => o.Amount).ToString("N2")</strong></span>
                                        </div>
                                        <div class="meta-item">
                                            <i class="fas fa-calendar-alt text-info me-2"></i>
                                            <span>Period: <strong>@DateTime.Now.ToString("MMMM yyyy")</strong></span>
                                        </div>
                                    </div>
                                }
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-4">
                        <div class="header-actions mt-3 mt-lg-0">
                            <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                                <RadzenButton Text="Add New Expense"
                                              Icon="add_circle_outline"
                                              Click="AddNew"
                                              ButtonStyle="ButtonStyle.Primary"
                                              Size="ButtonSize.Large"
                                              Class="shadow-sm me-2" />
                                <RadzenButton Text="Export PDF"
                                              Icon="picture_as_pdf"
                                              Click="@(args => ExportToPdf())"
                                              ButtonStyle="ButtonStyle.Success"
                                              Size="ButtonSize.Large"
                                              Class="shadow-sm" />
                            </div>
                        </div>
                    </div>
                </div>

                @if (Expenses != null)
                {
                    <div class="header-description mt-4">
                        <p class="mb-0">
                            <i class="fas fa-info-circle text-info me-2"></i>
                            Manage and track all your organizational expenses. Filter by date range or search specific records.
                        </p>
                    </div>
                }
            </div>
        </div>
    </div>

    <!-- Filter Controls Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm border-0">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-4">
                            
                            <!-- Search Box -->
                            <div class="d-flex align-items-center border rounded me-3" style="width: fit-content;">
                                <!-- Search Icon -->
                                <span class="ps-2" style="font-size: 1.2rem; color: #6c757d;">
                                    <i class="fas fa-search"></i>
                                </span>

                                <!-- Search Text Box -->
                                <RadzenTextBox @bind-Value="@search" TValue="string" Placeholder="Search..." @oninput="OnSearch"
                                               Style="border: none; box-shadow: none; padding-left: 0.5rem;" />
                            </div>

                        </div>
                        <div class="col-md-4">
                        </div>
                        <div class="col-md-4">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <div class="input-group">
                                        <RadzenDatePicker @bind-Value="fromDate"
                                                          DateFormat="yyyy-MM-dd"
                                                          Placeholder="From Date"
                                                          Style="border-left: none;"
                                                          Class="w-100" />
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="input-group">
                                        
                                        <RadzenDatePicker @bind-Value="toDate"
                                                          DateFormat="yyyy-MM-dd"
                                                          Placeholder="To Date"
                                                          Style="border-left: none;"
                                                          Class="w-100" />
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- DataGrid Section -->
    <div class="row">
        <div class="col-12">
            @if (Expenses == null)
            {
                <div class="card shadow-sm border-0">
                    <div class="card-body text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-3 mb-0 text-muted">Loading expenses data...</p>
                    </div>
                </div>
            }
            else if (!Expenses.Any())
            {
                <div class="card shadow-sm border-0">
                    <div class="card-body text-center py-5">
                        <div class="empty-state">
                            <i class="fas fa-receipt fa-3x text-muted mb-3"></i>
                            <h4 class="text-muted">No Expenses Found</h4>
                            <p class="text-muted">No expense records available for the selected period.</p>
                            <RadzenButton Text="Add Your First Expense"
                                          Icon="add_circle_outline"
                                          Click="AddNew"
                                          ButtonStyle="ButtonStyle.Primary"
                                          Size="ButtonSize.Medium"
                                          Class="mt-3" />
                        </div>
                    </div>
                </div>
            }
            else
            {
                <div class="card shadow-sm border-0">
                    <div class="card-body p-0">
                        <RadzenDataGrid Data="@FilterExpenses" TItem="Expense" PageSize="10"
                                        AllowPaging="true" AllowSorting="true" AllowFiltering="false"
                                        Class="border-0">
                            <Columns>
                                <RadzenDataGridColumn TItem="Expense" Property="@nameof(Expense.DateFormatted)" Title="Date" Width="120px" />
                                <RadzenDataGridColumn TItem="Expense" Title="Expense Type" Width="180px">
                                    <Template Context="context">
                                        <div class="d-flex align-items-center">
                                            <span>@context.ExpenseType?.Name</span>
                                        </div>
                                    </Template>
                                </RadzenDataGridColumn>
                                <RadzenDataGridColumn TItem="Expense" Title="Amount" Width="150px" TextAlign="TextAlign.Right">
                                    <Template Context="item">
                                        <div class="text-end">
                                            
                                                ৳@item.Amount.ToString("N2")
                                        </div>
                                    </Template>
                                    <FooterTemplate>
                                        <div class="text-end fw-bold fs-6">
                                            Total: ৳@FilterExpenses.Sum(o => o.Amount).ToString("N2")
                                        </div>
                                    </FooterTemplate>
                                </RadzenDataGridColumn>
                                <RadzenDataGridColumn TItem="Expense" Title="Description" Width="250px">
                                    <Template Context="context">
                                        @if (!string.IsNullOrEmpty(context.Description))
                                        {
                                            <div class="text-truncate" style="max-width: 200px;" title="@context.Description">
                                                @context.Description
                                            </div>
                                        }
                                        else
                                        {
                                            <span class="text-muted fst-italic">No description</span>
                                        }
                                    </Template>
                                </RadzenDataGridColumn>
                                <RadzenDataGridColumn TItem="Expense" Title="Actions" Width="120px" TextAlign="TextAlign.Center">
                                    <Template Context="context">
                                        <div class="btn-group btn-group-sm">
                                            <RadzenButton Icon="edit" ButtonStyle="ButtonStyle.Primary" Size="ButtonSize.Medium"
                                                          Click="() => Edit(context.Id)" title="Edit" style="margin-right: 5px;" />
                                            <RadzenButton Icon="delete" ButtonStyle="ButtonStyle.Danger" Size="ButtonSize.Medium"
                                                          Click="() => ConfirmDelete(context.Id)" title="Delete" />
                                        </div>
                                    </Template>
                                </RadzenDataGridColumn>
                            </Columns>
                        </RadzenDataGrid>
                    </div>
                </div>
            }
        </div>
    </div>
</div>

<style>
    .dashboard-header {
        background: white;
        border-radius: 12px;
        padding: 2rem;
        box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        border: 1px solid rgba(0,0,0,0.05);
    }

    .icon-circle {
        width: 70px;
        height: 70px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.8rem;
    }

    .bg-gradient-warning {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    }

    .bg-gradient-primary {
        background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
    }

    .bg-gradient-success {
        background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
    }

    .header-meta .meta-item {
        display: inline-flex;
        align-items: center;
        padding: 0.5rem 1rem;
        background: rgba(0,0,0,0.03);
        border-radius: 8px;
        font-size: 0.9rem;
    }

    .header-content h1 {
        color: #2d3748;
    }

    .header-description {
        padding-top: 1rem;
        border-top: 1px solid rgba(0,0,0,0.1);
        color: #4a5568;
    }

    .expense-type-icon {
        width: 32px;
        height: 32px;
        background: rgba(255, 193, 7, 0.1);
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .empty-state {
        padding: 3rem 0;
    }

    .input-group-text {
        border-right: none !important;
    }

    .border-end-0 {
        border-right: 0 !important;
    }

    .border-start-0 {
        border-left: 0 !important;
    }
</style>

<!-- Modal Section (Keep your existing modal code here) -->
@if (showModal)
{
    <div class="modal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="1" style="display:block">
        <div class="modal-dialog modal-lg modal-dialog-scrollable modal-dialog-centered">
            <div class="modal-content card dataFormPop">
                <div class="modal-header">
                    <h3>@(Expense.Id > 0 ? "Edit Monthly Expense" : "Add Monthly Expense")</h3>
                </div>

                <EditForm Model="@Expense" OnValidSubmit="HandleSubmit">
                    <DataAnnotationsValidator />
                    <ValidationSummary />

                    <div class="card dataForm ">
                        <div class="row m-3">
                            <div class="col-md-4 mb-3">
                                <label class="Asterisk form-label">Date</label>
                                <RadzenDatePicker @bind-Value="Expense.ExpenseDate" DateFormat="yyyy-MM-dd" Class="w-100" />
                            </div>

                            <div class="col-md-4 mb-3">
                                <label class="Asterisk form-label" for="ExpenseTypes">Expense Types</label>
                                <RadzenDropDown @bind-Value="Expense.ExpenseTypeId"
                                                Data="@ExpenseTypes"
                                                TextProperty="Name"
                                                ValueProperty="Id"
                                                Placeholder="Select Expense Type"
                                                Class="w-100"
                                                AllowClear="true"
                                                AllowFiltering="true"
                                                FilterCaseSensitivity="FilterCaseSensitivity.CaseInsensitive" />
                                <ValidationMessage For="@(() => Expense.ExpenseTypeId)" />
                            </div>

                            <div class="col-md-4 mb-3">
                                <label class="Asterisk form-label">Amount</label>
                                <InputNumber @bind-Value="Expense.Amount" class="form-control" />
                                <ValidationMessage For="@(() => Expense.Amount)" />
                            </div>
                        </div>

                        <div class="row m-3">
                            <div class="col-md-8 mb-3">
                                <label>Description</label>
                                <RadzenTextArea @bind-Value="Expense.Description" class="form-control" />
                                <ValidationMessage For="@(() => Expense.Description)" />
                            </div>
                        </div>

                        <div class="col-md-12">
                            <RadzenButton Text="Save" ButtonStyle="ButtonStyle.Primary" Type="submit" Class="m-2" />
                            <RadzenButton Text="Cancel" ButtonStyle="ButtonStyle.Secondary" Click="CloseModal" Class="m-2" />
                        </div>
                    </div>
                </EditForm>
            </div>
        </div>
    </div>
}

@code {
    // Your existing code block with the following additions:

    // Add this method for clearing filters
    private void ClearFilters()
    {
        search = string.Empty;
        fromDate = null;
        toDate = null;
        FilterData();
    }

    // Rest of your existing code remains the same...
    [Inject]
    private IExpense m_Expense { get; set; }

    [Inject]
    private NavigationManager _navigationManager { get; set; }

    public IEnumerable<Expense> Expenses { get; set; } = new List<Expense>();
    public IEnumerable<Lov> ExpenseTypes { get; set; } = new List<Lov>();

    private bool showModal = false;
    public Expense Expense { get; set; }
    private Message notificationComponent;
    [Inject] private IJSRuntime JSRuntime { get; set; }
    private IEnumerable<Expense> FilterExpenses { get; set; } = new List<Expense>();
    private string search = string.Empty;
    private DateTime? _fromDate;
    private DateTime? _toDate;

    protected override async Task OnInitializedAsync()
    {
        ExpenseTypes = await m_Lookup.GetAllExpenseTypeList();
        await LoadData();
    }


    private async Task HandleSubmit()
    {
        try
        {
            if (Expense.Amount <= 0)
            {
                notificationComponent.Show("Missing Summary", "Amount can not be 0", NotificationSeverity.Warning);
                return;
            }

            if (Expense.ExpenseTypeId == 0)
            {
                notificationComponent.Show("Missing Summary", "Expense Type Need to select", NotificationSeverity.Warning);
                return;
            }

            if (Expense.Id > 0)
            {
                m_Expense.UpdateExpense(Expense);
                notificationComponent.Show("Updated Summary", "Expense has been Updated successfully", NotificationSeverity.Warning);
            }
            else
            {
                m_Expense.CreateExpense(Expense);
                notificationComponent.Show("Added Summary", "Expense has been Added successfully", NotificationSeverity.Success);
            }

            await LoadData();
            CloseModal();
        }
        catch (Exception ex)
        {
            Console.WriteLine("Submit Error: " + ex.Message);
        }
    }

    private void Edit(int id)
    {
        showModal = true;

        if (id > 0)
        {
            Expense = m_Expense.GetExpense(id);
        }
        else
        {
            Expense = new Expense()
                {
                    Amount = 0,
                    ExpenseDate = DateTime.Now,
                    ExpenseTypeId = ExpenseTypes.FirstOrDefault()?.Id ?? 0,
                };
        }
    }

    async Task ConfirmDelete(int id)
    {
        var options = new ConfirmOptions()
            {
                OkButtonText = "Yes, Delete",
                CancelButtonText = "No, Keep",
                ShowClose = true,
            };

        bool? confirmed = await DialogService.Confirm("Are you absolutely sure you want to delete this item?", "Delete Confirmation", options);

        if (confirmed == true)
        {
            await Delete(id);
        }
    }

    async Task Delete(int id)
    {
        m_Expense.DeleteExpense(id);
        notificationComponent.Show("Delete Summary", "Expense has been Deleted successfully", NotificationSeverity.Error);

        await LoadData();
        StateHasChanged(); // If you are managing the data source manually
    }


    private void AddNew()
    {
        Expense = new Expense()
            {
                Amount = 0,
                ExpenseDate = DateTime.Now,
            };
        showModal = true;
    }

    private async Task LoadData()
    {
        Expenses = await m_Expense.GetAllExpenses(null, null);
        FilterExpenses = Expenses;
    }


    private async void LoadSalesHistory()
    {
        Expenses = await m_Expense.GetAllExpenses(fromDate, toDate);
        FilterExpenses = Expenses;

        FilterData();

        StateHasChanged();
    }

    private void CloseModal()
    {
        showModal = false;
    }


    public DateTime? fromDate
    {
        get => _fromDate;
        set
        {
            if (_fromDate != value)
            {
                _fromDate = value;
                LoadSalesHistory();
            }
        }
    }

    public DateTime? toDate
    {
        get => _toDate;
        set
        {
            if (_toDate != value)
            {
                _toDate = value;
                LoadSalesHistory();
            }
        }
    }


    private void OnSearch(ChangeEventArgs e)
    {
        search = e.Value?.ToString() ?? string.Empty;
        FilterData();
    }

    private void FilterData()
    {
        if (string.IsNullOrWhiteSpace(search))
        {
            FilterExpenses = Expenses;
        }
        else
        {
            FilterExpenses = Expenses.Where(c =>
                (!string.IsNullOrEmpty(c.ExpenseType.Name) && c.ExpenseType.Name.Contains(search, StringComparison.OrdinalIgnoreCase)) ||
                (!string.IsNullOrEmpty(c.Description) && c.Description.Contains(search, StringComparison.OrdinalIgnoreCase)) ||
                (!string.IsNullOrEmpty(c.Amount.ToString()) && c.Amount.ToString().Contains(search, StringComparison.OrdinalIgnoreCase)) ||
                (!string.IsNullOrEmpty(c.DateFormatted) && c.DateFormatted.Contains(search, StringComparison.OrdinalIgnoreCase))
            ).ToList();
        }


        // Apply date filtering with proper date-only comparison
        if (fromDate.HasValue || toDate.HasValue)
        {
            // Convert to DateOnly for comparison (or use DateTime.Date)
            var filterFrom = fromDate?.Date ?? DateTime.MinValue;
            var filterTo = toDate?.Date.AddDays(1) ?? DateTime.MaxValue; // Add 1 day to include entire end date

            FilterExpenses = FilterExpenses.Where(x =>
                x.ExpenseDate.Date >= filterFrom &&
                x.ExpenseDate.Date < filterTo
            ).ToList();
        }


    }

    public async Task ExportToPdf()
    {
        if (!ValidationHelper.ValidateAndNotify(FilterExpenses, notificationComponent))
            return;

        var document = Document.Create(container =>
        {
            container.Page(page =>
            {
                // Set individual margins
                page.MarginTop(20);     // Top margin
                page.MarginBottom(20);  // Bottom margin
                page.MarginLeft(40);    // Left margin
                page.MarginRight(40);   // Right margin

                page.Size(PageSizes.A4);
                page.DefaultTextStyle(style => style.FontSize(10));

                page.Header().Element(ComposeHeader);

                page.Content()
                    .PaddingVertical(10)
                    .Table(table =>
                    {
                        table.ColumnsDefinition(columns =>
                        {
                            columns.RelativeColumn(3);
                            columns.RelativeColumn(2);
                            columns.RelativeColumn(2);
                            columns.RelativeColumn(3);
                            columns.RelativeColumn(3);
                        });

                        // Header
                        table.Header(header =>
                        {
                            header.Cell().Background("#f5f5f5").Padding(5).Text("Expense Type").Bold();
                            header.Cell().Background("#f5f5f5").Padding(5).Text("Amount").Bold();
                            header.Cell().Background("#f5f5f5").Padding(5).Text("Description").Bold();
                            header.Cell().Background("#f5f5f5").Padding(5).Text("Payment Method").Bold();
                            header.Cell().Background("#f5f5f5").Padding(5).Text("Date").Bold();
                        });

                        // Data rows
                        foreach (var customer in FilterExpenses)
                        {
                            table.Cell().PaddingVertical(5).PaddingHorizontal(5).Text(customer.ExpenseType.Name);
                            table.Cell().PaddingVertical(5).PaddingHorizontal(5).Text(customer.Amount);
                            table.Cell().PaddingVertical(5).PaddingHorizontal(5).Text(customer.Description);
                            table.Cell().PaddingVertical(5).PaddingHorizontal(5).Text(customer.DateFormatted);
                        }

                        // Total Row
                        table.Cell().ColumnSpan(1).PaddingVertical(5).PaddingHorizontal(5).AlignRight().Text("Total").Bold();
                        table.Cell().PaddingVertical(5).PaddingHorizontal(5).Text($"৳{FilterExpenses.Sum(x => x.Amount):N2}").Bold();
                        table.Cell().PaddingVertical(5).PaddingHorizontal(5).Text("").Bold();
                        table.Cell().PaddingVertical(5).PaddingHorizontal(5).Text("").Bold();
                        table.Cell().PaddingVertical(5).PaddingHorizontal(5).Text("").Bold();
                    });

                page.Footer().Row(row =>
                    {
                        row.RelativeItem().AlignLeft().Text(DateTime.Now.ToString("dd/MM/yyyy HH:mm"));
                        row.RelativeItem().AlignCenter().Text(text =>
                        {
                            text.CurrentPageNumber();
                            text.Span(" / ");
                            text.TotalPages();
                        });
                        row.RelativeItem(); // Empty space for right side (optional)
                    });
            });
        });

        using var stream = new MemoryStream();
        document.GeneratePdf(stream);

        var fileName = $"Expenses_{DateTime.Now:yyyyMMddHHmmss}.pdf";
        await JSRuntime.InvokeVoidAsync("downloadFile", fileName, "application/pdf", stream.ToArray());
    }

    void ComposeHeader(IContainer container)
    {
        var company = m_Lookup.GetCompanyInfo();

        container.Row(row =>
        {
            row.RelativeItem().Column(column =>
            {
                column.Item().AlignCenter().Text($"{company.CompanyName}").Bold().FontSize(16);
                column.Item().AlignCenter().Text($"{company.Address}").FontSize(10);
                column.Item().AlignCenter().Text($"Expenses Report").Bold().FontSize(10);
            });
        });
    }

}