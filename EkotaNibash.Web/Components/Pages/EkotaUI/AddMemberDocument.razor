@page "/member-documents/add/{MemberId:int}"
@page "/member-documents/edit/{Id:int}"
@inject NavigationManager Navigation
@inject IMemberDocument m_Document
@inject IEkotaMember m_Member
@inject ILookup m_Lookup
@inject DialogService DialogService
@rendermode @(new InteractiveServerRenderMode(prerender: false))

<PageTitle>@(IsEditMode ? "Edit Document" : "Upload Document")</PageTitle>

<div class="container-fluid">
    <!-- Dashboard Style Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="dashboard-header">
                <div class="row align-items-center">
                    <div class="col-lg-6">
                        <div class="d-flex align-items-center">
                            <div class="header-icon me-4">
                                <div class="icon-circle bg-gradient-@(IsEditMode ? "warning" : "primary")">
                                    <i class="fas @(IsEditMode ? "fa-edit" : "fa-file-upload") text-white"></i>
                                </div>
                            </div>
                            <div class="header-content">
                                <h1 class="display-6 fw-bold mb-2">
                                    @(IsEditMode ? "Edit Document" : "Upload New Document")
                                </h1>
                                <div class="header-meta">
                                    <div class="d-flex flex-wrap gap-3">
                                        @if (memberInfo != null)
                                        {
                                            <div class="meta-item">
                                                <i class="fas fa-user-tag text-primary me-1"></i>
                                                <span class="fw-medium">@memberInfo.Name</span>
                                            </div>
                                            <div class="meta-item">
                                                <i class="fas fa-hashtag text-info me-1"></i>
                                                <span class="fw-medium">ID: @memberInfo.MembershipNo</span>
                                            </div>
                                            <div class="meta-item">
                                                <i class="fas fa-calendar-alt text-success me-1"></i>
                                                <span>@memberInfo.DateOfBirth.ToString("dddd, MMMM dd, yyyy")</span>
                                            </div>
                                        }
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-6">
                        <div class="header-actions mt-3 mt-lg-0">
                            <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                                <RadzenButton Text="Back to Documents"
                                              Icon="list"
                                              Click="@(() => Navigation.NavigateTo($"/member-documents/{MemberId}"))"
                                              ButtonStyle="ButtonStyle.Light"
                                              Size="ButtonSize.Large" />
                                <RadzenButton Text="Back to Members"
                                              Icon="people"
                                              Click="BackToMembers"
                                              ButtonStyle="ButtonStyle.Secondary"
                                              Size="ButtonSize.Large" />
                            </div>
                            @if (IsEditMode && document != null)
                            {
                                <div class="mt-3 text-end">
                                    <div class="text-muted small">File Size</div>
                                    <div class="h4 fw-bold text-info">
                                        @((document.File?.Length / 1024.0)?.ToString("0.00") ?? "0") KB
                                    </div>
                                </div>
                            }
                        </div>
                    </div>
                </div>
                <div class="row mt-4">
                    <div class="col-12">
                        <div class="header-description">
                            <p class="lead mb-0">
                                <i class="fas fa-info-circle me-2"></i>
                                @(IsEditMode ?
                                                                "Update document information or replace the file." :
                                                                "Upload a new document file and provide details.")
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <style>
        .dashboard-header {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            border: 1px solid rgba(0,0,0,0.05);
        }

        .icon-circle {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
        }

        .bg-gradient-primary {
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
        }

        .bg-gradient-warning {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        .header-meta .meta-item {
            display: inline-flex;
            align-items: center;
            padding: 0.5rem 1rem;
            background: rgba(0,0,0,0.03);
            border-radius: 8px;
            font-size: 0.9rem;
        }

        .header-content h1 {
            color: #2d3748;
        }

        .header-description {
            padding-top: 1rem;
            border-top: 1px solid rgba(0,0,0,0.1);
            color: #4a5568;
        }

        .file-preview {
            width: 120px;
            height: 120px;
            border: 2px dashed #dee2e6;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

            .file-preview img {
                max-width: 100%;
                max-height: 100%;
                object-fit: contain;
            }

        .upload-area {
            border: 2px dashed #6c757d;
            border-radius: 10px;
            padding: 2rem;
            text-align: center;
            background: #f8f9fa;
            cursor: pointer;
            transition: all 0.3s;
        }

            .upload-area:hover {
                border-color: #0d6efd;
                background: #e7f1ff;
            }
    </style>

    <EditForm Model="document" OnValidSubmit="HandleValidSubmit">
        <DataAnnotationsValidator />
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-@(IsEditMode ? "warning" : "primary") text-white">
                <h5 class="mb-0">
                    <i class="fas @(IsEditMode ? "fa-edit" : "fa-file-upload") me-2"></i>
                    @(IsEditMode ? "Edit Document Information" : "Document Information")
                </h5>
            </div>
            <div class="card-body">
                <ValidationSummary class="alert alert-danger" />

                <div class="row g-3 mb-4">
                    <h6 class="text-@(IsEditMode ? "warning" : "primary") border-bottom pb-2">
                        <i class="fas fa-info-circle me-2"></i>Document Details
                    </h6>

                    <div class="col-md-4">
                        <div class="form-group">
                            <RadzenLabel Text="Document Name *" />
                            <RadzenTextBox @bind-Value="document.DocumentName"
                                           Placeholder="Enter document name"
                                           MaxLength="100"
                                           Class="w-100" />
                            <ValidationMessage For="@(() => document.DocumentName)"
                                               class="text-danger small" />
                        </div>
                    </div>

                    <div class="col-md-4">
                        <div class="form-group">
                            <RadzenLabel Text="Document Type *" />
                            <RadzenDropDown Data="@documentTypes" @bind-Value="document.DocumentTypeId"
                                            TextProperty="Name" ValueProperty="Id"
                                            Placeholder="Select document type"
                                            Class="w-100" />
                            <ValidationMessage For="@(() => document.DocumentTypeId)"
                                               class="text-danger small" />
                        </div>
                    </div>

                    <div class="col-md-4">
                        <div class="form-group">
                            <RadzenLabel Text="Document Date" />
                            <RadzenDatePicker @bind-Value="document.DocumentDate"
                                              DateFormat="dd/MM/yyyy"
                                              Class="w-100" />
                        </div>
                    </div>

                    

                    <div class="col-12">
                        <div class="form-group">
                            <RadzenLabel Text="Description" />
                            <RadzenTextArea @bind-Value="document.Description"
                                            Placeholder="Enter document description"
                                            Rows="3"
                                            MaxLength="4000"
                                            Class="w-100" />
                            <ValidationMessage For="@(() => document.Description)"
                                               class="text-danger small" />
                        </div>
                    </div>
                </div>

                <div class="row g-3 mb-4">
                    <h6 class="text-@(IsEditMode ? "warning" : "primary") border-bottom pb-2">
                        <i class="fas fa-file me-2"></i>Document File
                    </h6>

                    <div class="col-md-12">
                        <div class="form-group">
                            @if (IsEditMode && document.File != null && document.File.Length > 0)
                            {
                                <div class="mb-4">
                                    <RadzenLabel Text="Current Document" />
                                    <div class="d-flex align-items-center">
                                        <div class="me-4">
                                            <div class="file-preview p-3 bg-light">
                                                @if (IsImageFile(document.FileName))
                                                {
                                                    <img src="data:image/jpeg;base64,@Convert.ToBase64String(document.File)"
                                                         alt="@document.FileName" />
                                                }
                                                else
                                                {
                                                    <i class="fas @GetFileIconClass(document.FileName) fa-3x text-@(IsEditMode ? "warning" : "primary")"></i>
                                                }
                                            </div>
                                        </div>
                                        <div class="flex-grow-1">
                                            <div class="mb-2">
                                                <strong>@document.FileName</strong>
                                            </div>
                                            <div class="text-muted mb-3">
                                                @((document.File.Length / 1024.0).ToString("0.00")) KB •
                                                @document.FileType.ToUpper()
                                            </div>
                                            <div class="d-flex gap-2">
                                                <RadzenButton Text="Download"
                                                              Icon="download"
                                                              Click="@DownloadCurrentDocument"
                                                              ButtonStyle="ButtonStyle.Secondary"
                                                              Size="ButtonSize.Medium" />
                                                <RadzenButton Text="Remove"
                                                              Icon="delete"
                                                              Click="@RemoveDocument"
                                                              ButtonStyle="ButtonStyle.Danger"
                                                              Size="ButtonSize.Medium" />
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <RadzenLabel Text="Replace Document (Optional)" />
                            }
                            else
                            {
                                <RadzenLabel Text="Upload Document *" />
                            }

                            @if (string.IsNullOrEmpty(uploadedFileName))
                            {
                                <div class="upload-area" onclick="document.getElementById('fileUpload').click()">
                                    <div class="mb-3">
                                        <i class="fas fa-cloud-upload-alt fa-3x text-muted"></i>
                                    </div>
                                    <h5 class="mb-2">Click to upload or drag and drop</h5>
                                    <p class="text-muted mb-0">
                                        Supported formats: PDF, DOC, DOCX, JPG, PNG, GIF, BMP<br />
                                        Max file size: 7MB
                                    </p>
                                    <InputFile id="fileUpload"
                                               style="display: none;"
                                               accept=".pdf,.doc,.docx,.xlsx,.txt,.pptx,.ppt,.rtf,.jpg,.jpeg,.png,.bmp,.gif"
                                               OnChange="OnFileChange" />
                                </div>
                            }
                            else
                            {
                                <div class="border rounded p-3 bg-light">
                                    <div class="d-flex align-items-center justify-content-between">
                                        <div class="d-flex align-items-center">
                                            <i class="fas @GetFileIconClass(uploadedFileName) fa-2x text-success me-3"></i>
                                            <div>
                                                <div class="fw-medium">@uploadedFileName</div>
                                                <div class="text-muted small">@((uploadedFileSize / 1024.0).ToString("0.00")) KB</div>
                                            </div>
                                        </div>
                                        <div>
                                            <RadzenButton Icon="close" ButtonStyle="ButtonStyle.Danger"
                                                          Size="ButtonSize.Medium"
                                                          Click="@ClearUpload" />
                                        </div>
                                    </div>
                                </div>
                            }

                            @if (uploadError)
                            {
                                <div class="alert alert-danger mt-3" role="alert">
                                    <i class="fas fa-exclamation-triangle me-2"></i>
                                    @errorMessage
                                </div>
                            }

                            <ValidationMessage For="@(() => document.File)"
                                               class="text-danger small" />
                        </div>
                    </div>
                </div>

                <div class="d-flex justify-content-between">
                    <div>
                        <RadzenButton Text="Cancel"
                                      ButtonStyle="ButtonStyle.Secondary"
                                      Click="Cancel"
                                      Class="me-2" />
                        @if (IsEditMode)
                        {
                            <RadzenButton Text="Delete"
                                          ButtonStyle="ButtonStyle.Danger"
                                          Click="ConfirmDelete"
                                          Class="me-2" />
                        }
                    </div>
                    <div>
                        <RadzenButton Text="@(IsEditMode ? "Update Document" : "Upload Document")"
                                      Icon="save"
                                      ButtonStyle="ButtonStyle.Primary"
                                      Type="submit"
                                      Disabled="@isSubmitting" />
                    </div>
                </div>
            </div>
        </div>
    </EditForm>
</div>

@code {
    [Parameter] public int Id { get; set; }
    [Parameter] public int MemberId { get; set; }

    private MemberDocument document = new();
    private EkotaMember? memberInfo;
    private bool IsEditMode => Id > 0;
    private bool isSubmitting = false;
    private bool uploadError = false;
    private string errorMessage = string.Empty;

    // File upload variables
    private string uploadedFileName = string.Empty;
    private long uploadedFileSize = 0;
    private byte[] uploadedFileBytes = Array.Empty<byte>();

    private IList<Lov> documentTypes = new List<Lov>();
    //private List<LookupItem> nominees = new();

    protected override async Task OnInitializedAsync()
    {
        try
        {
            memberInfo = await m_Member.GetByIdAsync(MemberId);
            await LoadLookupData();

            if (IsEditMode)
            {
                document = m_Document.GetDocument(Id);
                if (document?.FileName != null)
                {
                    uploadedFileName = document.FileName;
                }
            }
            else
            {
                document.EkotaMemberId = MemberId;
                document.DocumentDate = DateTime.Today;
            }
        }
        catch (Exception ex)
        {
            await DialogService.Alert($"Error loading data: {ex.Message}", "Error");
        }
    }

    private async Task LoadLookupData()
    {
        documentTypes = await m_Lookup.GetAllDocumentTypeList();
    }

    private async Task OnFileChange(InputFileChangeEventArgs e)
    {
        uploadError = false;
        errorMessage = string.Empty;

        try
        {
            var file = e.File;
            uploadedFileName = file.Name;
            uploadedFileSize = file.Size;

            // Validate file size (7MB limit based on your domain class)
            const long maxFileSize = 7 * 1024 * 1024; // 7MB
            if (file.Size > maxFileSize)
            {
                uploadError = true;
                errorMessage = $"File size exceeds 7MB limit. Current size: {(file.Size / 1024.0 / 1024.0):0.00} MB";
                ClearUpload();
                return;
            }

            // Validate file type
            var isValid = document.IsFileValid(file.Name, Array.Empty<byte>(), Path.GetExtension(file.Name));
            if (!isValid)
            {
                uploadError = true;
                errorMessage = "Invalid file type. Please upload a supported file format.";
                ClearUpload();
                return;
            }

            // Read file into byte array
            using var stream = file.OpenReadStream(maxFileSize);
            using var memoryStream = new MemoryStream();
            await stream.CopyToAsync(memoryStream);
            uploadedFileBytes = memoryStream.ToArray();

            // Validate with domain method
            if (!document.IsFileValid(file.Name, uploadedFileBytes, Path.GetExtension(file.Name)))
            {
                uploadError = true;
                errorMessage = "File validation failed.";
                ClearUpload();
                return;
            }

            StateHasChanged();
        }
        catch (Exception ex)
        {
            uploadError = true;
            errorMessage = $"Error uploading file: {ex.Message}";
            ClearUpload();
        }
    }

    private void ClearUpload()
    {
        uploadedFileName = string.Empty;
        uploadedFileSize = 0;
        uploadedFileBytes = Array.Empty<byte>();
        uploadError = false;
        errorMessage = string.Empty;
        StateHasChanged();
    }

    private bool IsImageFile(string fileName)
    {
        if (string.IsNullOrEmpty(fileName)) return false;
        var extension = Path.GetExtension(fileName).ToLowerInvariant();
        return extension switch
        {
            ".jpg" or ".jpeg" or ".png" or ".gif" or ".bmp" => true,
            _ => false
        };
    }

    private string GetFileIconClass(string fileName)
    {
        var extension = Path.GetExtension(fileName)?.ToLower();
        return extension switch
        {
            ".pdf" => "fa-file-pdf",
            ".doc" or ".docx" => "fa-file-word",
            ".xlsx" or ".xls" => "fa-file-excel",
            ".jpg" or ".jpeg" or ".png" or ".gif" or ".bmp" => "fa-file-image",
            ".zip" or ".rar" => "fa-file-archive",
            ".txt" => "fa-file-alt",
            _ => "fa-file"
        };
    }

    private async Task DownloadCurrentDocument()
    {
        if (document?.File != null && !string.IsNullOrEmpty(document.FileName))
        {
            var mimeType = GetMimeType(document.FileName);
            var base64 = Convert.ToBase64String(document.File);
            var js = $"var link = document.createElement('a'); link.download = '{document.FileName}'; link.href = 'data:{mimeType};base64,{base64}'; document.body.appendChild(link); link.click(); document.body.removeChild(link);";
            await JSRuntime.InvokeVoidAsync("eval", js);
        }
    }

    private void RemoveDocument()
    {
        document.File = null;
        document.FileName = null;
        document.FileType = null;
        uploadedFileName = string.Empty;
        uploadedFileBytes = Array.Empty<byte>();
        StateHasChanged();
    }

    private async Task HandleValidSubmit()
    {
        isSubmitting = true;

        try
        {
            // Handle file upload if new file was selected
            if (!string.IsNullOrEmpty(uploadedFileName) && uploadedFileBytes.Length > 0)
            {
                document.File = uploadedFileBytes;
                document.FileName = uploadedFileName;
                document.FileType = Path.GetExtension(uploadedFileName);
            }

            if (IsEditMode)
            {
                // Update existing document
                // Note: You might need to add an Update method to your IMemberDocument interface
                // For now, we'll use CreateDocument which might handle updates if Id > 0
                var result = m_Document.CreateDocument(document);
                if (result > 0)
                {
                    await DialogService.Alert("Document updated successfully!", "Success");
                    Navigation.NavigateTo($"/member-documents/{MemberId}");
                }
            }
            else
            {
                // Create new document
                document.EkotaMemberId = MemberId;
                var result = m_Document.CreateDocument(document);
                if (result > 0)
                {
                    await DialogService.Alert("Document uploaded successfully!", "Success");
                    Navigation.NavigateTo($"/member-documents/{MemberId}");
                }
            }
        }
        catch (Exception ex)
        {
            await DialogService.Alert($"Error: {ex.Message}", "Error");
        }
        finally
        {
            isSubmitting = false;
        }
    }

    private async Task ConfirmDelete()
    {
        var confirmed = await DialogService.Confirm(
            "Are you sure you want to delete this document? This action cannot be undone.",
            "Delete Document",
            new ConfirmOptions { OkButtonText = "Delete", CancelButtonText = "Cancel" });

        if (confirmed == true)
        {
            try
            {
                var result = m_Document.DeleteDocument(Id);
                if (result)
                {
                    await DialogService.Alert("Document deleted successfully!", "Success");
                    Navigation.NavigateTo($"/member-documents/{MemberId}");
                }
            }
            catch (Exception ex)
            {
                await DialogService.Alert($"Error deleting document: {ex.Message}", "Error");
            }
        }
    }

    private string GetMimeType(string fileName)
    {
        var extension = Path.GetExtension(fileName).ToLowerInvariant();
        return extension switch
        {
            ".pdf" => "application/pdf",
            ".jpg" or ".jpeg" => "image/jpeg",
            ".png" => "image/png",
            ".gif" => "image/gif",
            ".bmp" => "image/bmp",
            ".doc" => "application/msword",
            ".docx" => "application/vnd.openxmlformats-officedocument.wordprocessingml.document",
            ".xlsx" => "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
            ".txt" => "text/plain",
            ".ppt" => "application/vnd.ms-powerpoint",
            ".pptx" => "application/vnd.openxmlformats-officedocument.presentationml.presentation",
            ".rtf" => "application/rtf",
            _ => "application/octet-stream"
        };
    }

    private void BackToMembers()
    {
        Navigation.NavigateTo("/members");
    }

    private void Cancel()
    {
        Navigation.NavigateTo($"/member-documents/{MemberId}");
    }

    public class LookupItem
    {
        public string Value { get; set; }
        public string Text { get; set; }
    }

    [Inject] private IJSRuntime JSRuntime { get; set; }
}