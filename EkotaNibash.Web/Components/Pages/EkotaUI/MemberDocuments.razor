@page "/member-documents/{MemberId:int}"
@inject NavigationManager Navigation
@inject IMemberDocument m_Document
@inject IEkotaMember m_Member
@inject ILookup m_Lookup
@inject DialogService DialogService
@rendermode @(new InteractiveServerRenderMode(prerender: false))

<PageTitle>Member Documents</PageTitle>

<div class="container-fluid">
    <!-- Dashboard Style Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="dashboard-header">
                <div class="row align-items-center">
                    <div class="col-lg-6">
                        <div class="d-flex align-items-center">
                            <div class="header-icon me-4">
                                <div class="icon-circle bg-gradient-primary">
                                    <i class="fas fa-file-alt text-white"></i>
                                </div>
                            </div>
                            <div class="header-content">
                                <h1 class="display-6 fw-bold mb-2">Document Management</h1>
                                <div class="header-meta">
                                    <div class="d-flex flex-wrap gap-3">
                                        @if (memberInfo != null)
                                        {
                                            <div class="meta-item">
                                                <i class="fas fa-user-tag text-primary me-1"></i>
                                                <span class="fw-medium">@memberInfo.Name</span>
                                            </div>
                                            <div class="meta-item">
                                                <i class="fas fa-hashtag text-info me-1"></i>
                                                <span class="fw-medium">ID: @memberInfo.MembershipNo</span>
                                            </div>
                                            <div class="meta-item">
                                                <i class="fas fa-calendar-alt text-success me-1"></i>
                                                <span>@memberInfo.DateOfBirth.ToString("dddd, MMMM dd, yyyy")</span>
                                            </div>
                                        }
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-6">
                        <div class="header-actions mt-3 mt-lg-0">
                            <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                                <RadzenButton Text="Upload Document"
                                              Icon="upload"
                                              Click="AddNewDocument"
                                              ButtonStyle="ButtonStyle.Primary"
                                              Size="ButtonSize.Large"
                                              Class="shadow-sm" />
                                <RadzenButton Text="Back to Members"
                                              Icon="people"
                                              Click="BackToMembers"
                                              ButtonStyle="ButtonStyle.Light"
                                              Size="ButtonSize.Large" />
                            </div>
                            @if (documents != null)
                            {
                                <div class="mt-3 text-end">
                                    <div class="text-muted small">Total Documents</div>
                                    <div class="h4 fw-bold text-primary">@documents.Count</div>
                                </div>
                            }
                        </div>
                    </div>
                </div>
                <div class="row mt-4">
                    <div class="col-12">
                        <div class="header-description">
                            <p class="lead mb-0">
                                <i class="fas fa-info-circle me-2"></i>
                                Manage all member documents, certificates, and supporting files in one place.
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <style>
        .dashboard-header {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            border: 1px solid rgba(0,0,0,0.05);
        }

        .icon-circle {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
        }

        .bg-gradient-primary {
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
        }

        .header-meta .meta-item {
            display: inline-flex;
            align-items: center;
            padding: 0.5rem 1rem;
            background: rgba(0,0,0,0.03);
            border-radius: 8px;
            font-size: 0.9rem;
        }

        .header-content h1 {
            color: #2d3748;
        }

        .header-description {
            padding-top: 1rem;
            border-top: 1px solid rgba(0,0,0,0.1);
            color: #4a5568;
        }

        .file-icon {
            font-size: 1.5rem;
        }

        .file-preview {
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
        }
    </style>

    <!-- Filter Controls -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm border-0">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-4">
                            <div class="d-flex align-items-center border rounded me-3" style="width: fit-content;">
                                <span class="ps-2" style="font-size: 1.2rem; color: #6c757d;">
                                    <i class="fas fa-search"></i>
                                </span>
                                <RadzenTextBox @bind-Value="@search" TValue="string"
                                               Placeholder="Search document name, type..."
                                               @oninput="OnSearch"
                                               Style="border: none; box-shadow: none; padding-left: 0.5rem;" />
                            </div>
                        </div>
                        <div class="col-md-4">
                        </div>
                       
                        <div class="col-md-4">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <div class="input-group">
                                        <RadzenDatePicker @bind-Value="fromDate"
                                                          DateFormat="yyyy-MM-dd"
                                                          Placeholder="From Date"
                                                          Style="width: 100%;"
                                                          Class="w-100" />
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="input-group">
                                        <RadzenDatePicker @bind-Value="toDate"
                                                          DateFormat="yyyy-MM-dd"
                                                          Placeholder="To Date"
                                                          Style="width: 100%;"
                                                          Class="w-100" />
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Documents Grid -->
    <RadzenDataGrid Data="@FilteredDocuments" TItem="DocumentListDTO" PageSize="10"
                    AllowPaging="true" AllowSorting="true" AllowFiltering="false"
                    EmptyText="No documents found">
        <Columns>
            <RadzenDataGridColumn TItem="DocumentListDTO" Property="@nameof(DocumentListDTO.DocumentDate)"
                                  Title="Date" Width="110px">
                <Template Context="doc">
                    @doc.DocumentDate.ToString("dd-MMM-yyyy")
                </Template>
            </RadzenDataGridColumn>

            <RadzenDataGridColumn TItem="DocumentListDTO" Property="@nameof(DocumentListDTO.DocumentType)"
                                  Title="Type" Width="140px" />

            <RadzenDataGridColumn TItem="DocumentListDTO" Property="@nameof(DocumentListDTO.DocumentName)"
                                  Title="Document Name" Width="200px">
                <Template Context="doc">
                    <div class="d-flex align-items-center">
                        <div class="file-preview me-3">
                            @GetFileIcon(doc.DocumentName)
                        </div>
                        <div>
                            <div class="fw-medium">@doc.DocumentName</div>
                            <small class="text-muted">@GetFileSize(doc.Id)</small>
                        </div>
                    </div>
                </Template>
            </RadzenDataGridColumn>

            <RadzenDataGridColumn TItem="DocumentListDTO" Property="@nameof(DocumentListDTO.Comments)"
                                  Title="Comments" Width="250px">
                <Template Context="doc">
                    @if (!string.IsNullOrEmpty(doc.Comments))
                    {
                        <div class="text-truncate" style="max-width: 250px;" title="@doc.Comments">
                            @doc.Comments
                        </div>
                    }
                    else
                    {
                        <span class="text-muted">No Comments</span>
                    }
                </Template>
            </RadzenDataGridColumn>

            <RadzenDataGridColumn TItem="DocumentListDTO" Title="Actions" Width="120px">
                <Template Context="doc">
                    <div class="btn-group btn-group-sm">
                        <RadzenButton Icon="visibility" ButtonStyle="ButtonStyle.Info" Size="ButtonSize.Medium"
                                      Click="() => ViewDocument(doc.Id)"
                                      style="margin-right: 5px;" title="View" />
                        <RadzenButton Icon="download" ButtonStyle="ButtonStyle.Success" Size="ButtonSize.Medium"
                                      Click="() => DownloadDocument(doc.Id)"
                                      style="margin-right: 5px;" title="Download" />
                        <RadzenButton Icon="delete" ButtonStyle="ButtonStyle.Danger" Size="ButtonSize.Medium"
                                      Click="() => ConfirmDelete(doc.Id)" title="Delete" />
                    </div>
                </Template>
            </RadzenDataGridColumn>
        </Columns>
    </RadzenDataGrid>
</div>

@code {
    [Parameter] public int MemberId { get; set; }

    private List<DocumentListDTO> documents = new();
    private List<DocumentListDTO> FilteredDocuments = new();
    private EkotaMember? memberInfo;
    private Dictionary<int, long> documentSizes = new();

    // Filter variables
    private string search = string.Empty;
    private DateTime? _fromDate;
    private DateTime? _toDate;
    private int? selectedDocumentType;

    protected override async Task OnInitializedAsync()
    {
        await LoadDocuments();

        try
        {
            memberInfo = await m_Member.GetByIdAsync(MemberId);
        }
        catch
        {
            // Silently handle
        }
    }

    private async Task LoadDocuments()
    {
        documents = (m_Document.GetAllMemberDocuments(MemberId)).ToList();
        FilteredDocuments = documents;

        // Pre-load document sizes
        foreach (var doc in documents)
        {
            var document = m_Document.GetDocument(doc.Id);
            if (document?.File != null)
            {
                documentSizes[doc.Id] = document.File.Length;
            }
        }
    }

    // Filter properties
    public DateTime? fromDate
    {
        get => _fromDate;
        set
        {
            if (_fromDate != value)
            {
                _fromDate = value;
                FilterData();
            }
        }
    }

    public DateTime? toDate
    {
        get => _toDate;
        set
        {
            if (_toDate != value)
            {
                _toDate = value;
                FilterData();
            }
        }
    }

    private void OnSearch(ChangeEventArgs e)
    {
        search = e.Value?.ToString() ?? string.Empty;
        FilterData();
    }

    private void FilterData()
    {
        if (string.IsNullOrWhiteSpace(search) && !fromDate.HasValue && !toDate.HasValue)
        {
            FilteredDocuments = documents;
        }
        else
        {
            var query = documents.AsQueryable();

            // Apply search filter
            if (!string.IsNullOrWhiteSpace(search))
            {
                query = query.Where(d =>
                    (!string.IsNullOrEmpty(d.DocumentName) && d.DocumentName.Contains(search, StringComparison.OrdinalIgnoreCase)) ||
                    (!string.IsNullOrEmpty(d.DocumentType) && d.DocumentType.Contains(search, StringComparison.OrdinalIgnoreCase)) ||
                    (!string.IsNullOrEmpty(d.Comments) && d.Comments.Contains(search, StringComparison.OrdinalIgnoreCase))
                );
            }

            // Apply document type filter
            if (selectedDocumentType.HasValue && selectedDocumentType.Value > 0)
            {
                query = query.Where(d => d.DocumentTypeId == selectedDocumentType);
            }

            // Apply date range filter
            if (fromDate.HasValue || toDate.HasValue)
            {
                var filterFrom = fromDate?.Date ?? DateTime.MinValue;
                var filterTo = toDate?.Date.AddDays(1) ?? DateTime.MaxValue;

                query = query.Where(d =>
                    d.DocumentDate.Date >= filterFrom &&
                    d.DocumentDate.Date < filterTo
                );
            }

            FilteredDocuments = query.ToList();
        }
        StateHasChanged();
    }

    private MarkupString GetFileIcon(string fileName)
    {
        var extension = Path.GetExtension(fileName)?.ToLower();
        var icon = extension switch
        {
            ".pdf" => "fas fa-file-pdf text-danger",
            ".doc" or ".docx" => "fas fa-file-word text-primary",
            ".xlsx" or ".xls" => "fas fa-file-excel text-success",
            ".jpg" or ".jpeg" or ".png" or ".gif" => "fas fa-file-image text-info",
            ".zip" or ".rar" => "fas fa-file-archive text-warning",
            _ => "fas fa-file text-secondary"
        };
        return new MarkupString($"<i class='{icon}'></i>");
    }

    private string GetFileSize(int documentId)
    {
        if (documentSizes.TryGetValue(documentId, out var size))
        {
            return FormatFileSize(size);
        }
        return "Unknown size";
    }

    private string FormatFileSize(long bytes)
    {
        string[] sizes = { "B", "KB", "MB", "GB" };
        int order = 0;
        double len = bytes;
        while (len >= 1024 && order < sizes.Length - 1)
        {
            order++;
            len = len / 1024;
        }
        return $"{len:0.##} {sizes[order]}";
    }

    private void AddNewDocument()
    {
        Navigation.NavigateTo($"/member-documents/add/{MemberId}");
    }

    private async Task ViewDocument(int id)
    {
        var document = m_Document.GetDocument(id);
        if (document != null && document.File != null)
        {
            var mimeType = GetMimeType(document.FileName);
            var base64 = Convert.ToBase64String(document.File);
            var js = $"var w = window.open(''); w.document.write('<iframe src=\"data:{mimeType};base64,{base64}\" style=\"width:100%;height:100%;border:none;\"></iframe>');";
            await JSRuntime.InvokeVoidAsync("eval", js);
        }
    }

    private async Task DownloadDocument(int id)
    {
        try
        {
            var document = m_Document.DownloadDocument(id);
            if (document?.File != null)
            {
                var mimeType = GetMimeType(document.FileName);
                var base64 = Convert.ToBase64String(document.File);
                var js = $"var link = document.createElement('a'); link.download = '{document.FileName}'; link.href = 'data:{mimeType};base64,{base64}'; document.body.appendChild(link); link.click(); document.body.removeChild(link);";
                await JSRuntime.InvokeVoidAsync("eval", js);
            }
        }
        catch (Exception ex)
        {
            await DialogService.Alert($"Error downloading document: {ex.Message}", "Error");
        }
    }

    private async Task ConfirmDelete(int id)
    {
        var confirmed = await DialogService.Confirm(
            "Are you sure you want to delete this document? This action cannot be undone.",
            "Delete Document",
            new ConfirmOptions { OkButtonText = "Delete", CancelButtonText = "Cancel" });

        if (confirmed == true)
        {
            try
            {
                var result = m_Document.DeleteDocument(id);
                if (result)
                {
                    await DialogService.Alert("Document deleted successfully!", "Success");
                    await LoadDocuments();
                }
            }
            catch (Exception ex)
            {
                await DialogService.Alert($"Error deleting document: {ex.Message}", "Error");
            }
        }
    }

    private string GetMimeType(string fileName)
    {
        var extension = Path.GetExtension(fileName).ToLowerInvariant();
        return extension switch
        {
            ".pdf" => "application/pdf",
            ".jpg" or ".jpeg" => "image/jpeg",
            ".png" => "image/png",
            ".gif" => "image/gif",
            ".doc" => "application/msword",
            ".docx" => "application/vnd.openxmlformats-officedocument.wordprocessingml.document",
            ".xlsx" => "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
            ".txt" => "text/plain",
            _ => "application/octet-stream"
        };
    }

    private void BackToMembers()
    {
        Navigation.NavigateTo("/members");
    }

    public class LookupItem
    {
        public string Value { get; set; }
        public string Text { get; set; }
    }

    [Inject] private IJSRuntime JSRuntime { get; set; }
}