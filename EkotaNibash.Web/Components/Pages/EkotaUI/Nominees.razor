@page "/nominees/{MemberId:int}"
@inject INominee m_Nominee
@inject IEkotaMember m_Member
@inject NavigationManager Navigation

@rendermode @(new InteractiveServerRenderMode(prerender: false))
@inject DialogService DialogService

<Message @ref="notificationComponent" />

<PageTitle>Nominees</PageTitle>

<div class="container-fluid">
    <!-- Dashboard Style Header for Nominee Add/Edit Page -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="dashboard-header">
                <div class="row align-items-center">
                    <div class="col-lg-6">
                        <div class="d-flex align-items-center">
                            <div class="header-icon me-4">
                                <div class="icon-circle bg-gradient-primary">
                                    <i class="fas fa-user-tag text-white"></i>
                                </div>
                            </div>
                            <div class="header-content">
                                <h1 class="display-6 fw-bold mb-2">Nominees</h1>
                                <div class="header-meta">
                                    <div class="d-flex flex-wrap gap-3">
                                        @if (memberInfo != null)
                                        {
                                            <div class="meta-item">
                                                <i class="fas fa-user-tag text-primary me-1"></i>
                                                <span class="fw-medium">@memberInfo.Name</span>
                                            </div>
                                            <div class="meta-item">
                                                <i class="fas fa-hashtag text-info me-1"></i>
                                                <span class="fw-medium">ID: @memberInfo.MembershipNo</span>
                                            </div>
                                            <div class="meta-item">
                                                <i class="fas fa-calendar-alt text-success me-1"></i>
                                                <span>@memberInfo.DateOfBirth.ToString("dddd, MMMM dd, yyyy")</span>
                                            </div>
                                            <div class="meta-item">
                                                <i class="fas fa-users text-warning me-1"></i>
                                                <span>Nominees: <strong>@FilteredNominees.Count</strong></span>
                                            </div>
                                        }
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-6">
                        <div class="header-actions mt-3 mt-lg-0">
                            <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                                <RadzenButton Text="Add New Nominee"
                                              Icon="add_circle_outline"
                                              Click="AddNewNominee"
                                              ButtonStyle="ButtonStyle.Primary"
                                              Size="ButtonSize.Large"
                                              Class="shadow-sm" />
                                <RadzenButton Text="Back to Members"
                                              Icon="people"
                                              Click="BackToMembers"
                                              ButtonStyle="ButtonStyle.Light"
                                              Size="ButtonSize.Large" />
                            </div>
                        </div>
                    </div>
                </div>

                @if (memberInfo != null)
                {
                    <div class="header-description mt-4">
                        <p class="mb-0">
                            <i class="fas fa-info-circle text-info me-2"></i>
                            Manage nominees for <strong>@memberInfo.Name</strong>. Search by name, NID, mobile number, or relationship.
                        </p>
                    </div>
                }
            </div>
        </div>
    </div>

    <!-- Filter Controls Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm border-0">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <!-- Search Box -->
                            <div class="d-flex align-items-center border rounded me-3" style="width: 100%; max-width: 500px;">
                                <!-- Search Icon -->
                                <span class="ps-2" style="font-size: 1.2rem; color: #6c757d;">
                                    <i class="fas fa-search"></i>
                                </span>

                                <!-- Search Text Box -->
                                <RadzenTextBox @bind-Value="@search" TValue="string"
                                               Placeholder="Search by name, NID, mobile, relationship..."
                                               @oninput="OnSearch"
                                               Style="border: none; box-shadow: none; padding-left: 0.5rem; width: 100%;" />
                            </div>
                        </div>
                        <div class="col-md-4 text-end">
                            @if (!string.IsNullOrEmpty(search))
                            {
                                <RadzenButton Text="Clear Search"
                                              Icon="clear_all"
                                              Click="ClearSearch"
                                              ButtonStyle="ButtonStyle.Secondary"
                                              Size="ButtonSize.Medium"
                                              Class="shadow-sm" />
                            }
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Nominees DataGrid -->
    <div class="row">
        <div class="col-12">
            @if (nominees == null || !nominees.Any())
            {
                <div class="card shadow-sm border-0">
                    <div class="card-body text-center py-5">
                        <div class="empty-state">
                            <i class="fas fa-user-tag fa-3x text-muted mb-3"></i>
                            <h4 class="text-muted">No Nominees Found</h4>
                            <p class="text-muted">No nominee records available for this member.</p>
                            <RadzenButton Text="Add First Nominee"
                                          Icon="add_circle_outline"
                                          Click="AddNewNominee"
                                          ButtonStyle="ButtonStyle.Primary"
                                          Size="ButtonSize.Medium"
                                          Class="mt-3" />
                        </div>
                    </div>
                </div>
            }
            else if (!FilteredNominees.Any())
            {
                <div class="card shadow-sm border-0">
                    <div class="card-body text-center py-5">
                        <div class="empty-state">
                            <i class="fas fa-search fa-3x text-muted mb-3"></i>
                            <h4 class="text-muted">No Matching Nominees</h4>
                            <p class="text-muted">No nominees found matching your search criteria.</p>
                            <RadzenButton Text="Clear Search"
                                          Icon="clear_all"
                                          Click="ClearSearch"
                                          ButtonStyle="ButtonStyle.Secondary"
                                          Size="ButtonSize.Medium"
                                          Class="mt-3" />
                        </div>
                    </div>
                </div>
            }
            else
            {
                <RadzenDataGrid Data="@FilteredNominees" TItem="Nominee" PageSize="10"
                                AllowPaging="true" AllowSorting="true" AllowFiltering="false"
                                Class="shadow-sm border-0">
                    <Columns>
                        <RadzenDataGridColumn TItem="Nominee" Property="@nameof(Nominee.Name)" Title="Name (English)" Width="180px" />
                        <RadzenDataGridColumn TItem="Nominee" Title="Photo" Width="80px">
                            <Template Context="member">
                                @if (!string.IsNullOrEmpty(member.PhotoBase64))
                                {
                                    <div style="width: 50px; height: 50px; border-radius: 50%; overflow: hidden;">
                                        <img src="@member.PhotoBase64"
                                             style="width: 100%; height: 100%; object-fit: cover;"
                                             alt="Nominee Photo" />
                                    </div>
                                }
                                else
                                {
                                    <div style="width: 50px; height: 50px; border-radius: 50%; background-color: #e9ecef; display: flex; align-items: center; justify-content: center;">
                                        <i class="fas fa-user text-muted"></i>
                                    </div>
                                }
                            </Template>
                        </RadzenDataGridColumn>
                        <RadzenDataGridColumn TItem="Nominee" Property="@nameof(Nominee.RelationshipWithMember)" Title="Relationship" Width="130px" />
                        <RadzenDataGridColumn TItem="Nominee" Property="@nameof(Nominee.DateOfBirth)" Title="Date of Birth" Width="120px">
                            <Template Context="nominee">
                                @nominee.DateOfBirth.ToString("dd-MMM-yyyy")
                            </Template>
                        </RadzenDataGridColumn>
                        <RadzenDataGridColumn TItem="Nominee" Property="@nameof(Nominee.NIDNumber)" Title="NID" Width="150px" />
                        <RadzenDataGridColumn TItem="Nominee" Property="@nameof(Nominee.MobileNumber)" Title="Mobile" Width="130px" />
                        <RadzenDataGridColumn TItem="Nominee" Property="@nameof(Nominee.BloodGroup)" Title="Blood Group" Width="120px" />
                        <RadzenDataGridColumn TItem="Nominee" Title="Actions" Width="120px">
                            <Template Context="nominee">
                                <div class="btn-group btn-group-sm">
                                    <RadzenButton Icon="edit" ButtonStyle="ButtonStyle.Primary" Size="ButtonSize.Medium"
                                                  Click="() => EditNominee(nominee.Id)" style="margin-right: 5px;" title="Edit" />
                                    <RadzenButton Icon="delete" ButtonStyle="ButtonStyle.Danger" Size="ButtonSize.Medium"
                                                  Click="() => ConfirmDelete(nominee.Id)" title="Delete" />
                                </div>
                            </Template>
                        </RadzenDataGridColumn>
                    </Columns>
                </RadzenDataGrid>
            }
        </div>
    </div>
</div>

<style>
    .dashboard-header {
        background: white;
        border-radius: 12px;
        padding: 2rem;
        box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        border: 1px solid rgba(0,0,0,0.05);
    }

    .icon-circle {
        width: 70px;
        height: 70px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.8rem;
    }

    .bg-gradient-primary {
        background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
    }

    .header-meta .meta-item {
        display: inline-flex;
        align-items: center;
        padding: 0.5rem 1rem;
        background: rgba(0,0,0,0.03);
        border-radius: 8px;
        font-size: 0.9rem;
    }

    .header-content h1 {
        color: #2d3748;
    }

    .header-description {
        padding-top: 1rem;
        border-top: 1px solid rgba(0,0,0,0.1);
        color: #4a5568;
    }

    .empty-state {
        padding: 3rem 0;
    }

    .card {
        border-radius: 12px;
    }
</style>

@code {
    [Parameter] public int MemberId { get; set; }

    private List<Nominee> nominees = new();
    private List<Nominee> FilteredNominees = new();
    private EkotaMember? memberInfo;

    // Search variable
    private string search = string.Empty;

    private Message notificationComponent;

    protected override async Task OnInitializedAsync()
    {
        await LoadNominees();

        try
        {
            memberInfo = await m_Member.GetByIdAsync(MemberId);
        }
        catch
        {
            // Silently handle - member info is optional for display
        }
    }

    private async Task LoadNominees()
    {
        // Fetch nominees by member ID
        nominees = await m_Nominee.GetAllAsync(MemberId);
        FilteredNominees = nominees;
    }

    // Search handler
    private void OnSearch(ChangeEventArgs e)
    {
        search = e.Value?.ToString() ?? string.Empty;
        FilterData();
    }

    // Clear search
    private void ClearSearch()
    {
        search = string.Empty;
        FilterData();
    }

    // Filter method
    private void FilterData()
    {
        if (string.IsNullOrWhiteSpace(search))
        {
            FilteredNominees = nominees;
        }
        else
        {
            FilteredNominees = nominees.Where(n =>
                (!string.IsNullOrEmpty(n.Name) && n.Name.Contains(search, StringComparison.OrdinalIgnoreCase)) ||
                (!string.IsNullOrEmpty(n.NIDNumber) && n.NIDNumber.Contains(search, StringComparison.OrdinalIgnoreCase)) ||
                (!string.IsNullOrEmpty(n.MobileNumber) && n.MobileNumber.Contains(search, StringComparison.OrdinalIgnoreCase)) ||
                (!string.IsNullOrEmpty(n.RelationshipWithMember) && n.RelationshipWithMember.Contains(search, StringComparison.OrdinalIgnoreCase)) ||
                (!string.IsNullOrEmpty(n.BloodGroup) && n.BloodGroup.Contains(search, StringComparison.OrdinalIgnoreCase))
            ).ToList();
        }
        StateHasChanged();
    }

    private void AddNewNominee()
    {
        Navigation.NavigateTo($"/nominees/add/{MemberId}");
    }

    private void EditNominee(int id)
    {
        Navigation.NavigateTo($"/nominees/edit/{id}");
    }

    private void BackToMembers()
    {
        Navigation.NavigateTo("/members");
    }


    private async Task ConfirmDelete(int id)
    {
        var options = new ConfirmOptions()
        {
            OkButtonText = "Yes, Delete",
            CancelButtonText = "No, Keep",
            ShowClose = true,
        };

        bool? confirmed = await DialogService.Confirm("Are you absolutely sure you want to delete this item?", "Delete Confirmation", options);

        if (confirmed == true)
        {
            await Delete(id);
        }
    }


    async Task Delete(int id)
    {
        m_Nominee.DeleteNominee(id);
        notificationComponent.Show("Delete Summary", "Nominee has been Deleted successfully", NotificationSeverity.Error);

        await LoadNominees();
        StateHasChanged(); // If you are managing the data source manually
    }
}